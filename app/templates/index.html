<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Загрузка файлов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="bg-light">
    <div class="container mt-5 p-4 border rounded shadow bg-white">
        <h1 class="text-center mb-4">Загрузка файлов</h1>

        <!-- Форма загрузки файлов -->
        <form method="POST" enctype="multipart/form-data" class="mb-4" id="uploadForm">
            <input type="file" id="fileInput" name="files[]" class="form-control mb-3" multiple required>

            <!-- Прогресс-бар -->
            <div id="progressContainer" style="display: none;">
                <p id="statusText" class="text-center">Ожидание начала загрузки...</p>
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
            </div>

            <!-- Кнопки -->
            <div class="d-flex justify-content-between">
                <button type="submit" class="btn btn-primary">Загрузить</button>
                <button type="reset" class="btn btn-secondary" onclick="resetForm()">Очистить</button>
            </div>
        </form>
    </div>

    <script>
        const form = document.getElementById("uploadForm");
        const progressContainer = document.getElementById("progressContainer");
        const progressBar = document.getElementById("progressBar");
        const statusText = document.getElementById("statusText");

        // Обработка отправки формы
        form.addEventListener("submit", async (e) => {
            e.preventDefault(); // Предотвращаем стандартное поведение формы

            const formData = new FormData(form);

            // Показываем прогресс-бар
            progressContainer.style.display = "block";
            statusText.innerText = "Загрузка файлов...";

            try {
                // Отправляем данные формы на сервер
                const response = await fetch("/", {
                    method: "POST",
                    body: formData
                });

                // Обрабатываем ответ сервера
                const data = await response.json();
                if (data.task_id) {
                    // Проверяем статус задачи
                    checkStatus(data.task_id, data.link);
                } else {
                    alert("Ошибка при загрузке файлов.");
                    console.error(data.error);
                }
            } catch (error) {
                console.error(error);
                alert("Ошибка сети!");
            }
        });

        // Функция проверки статуса задачи
        async function checkStatus(taskId, downloadLink) {
            try {
                const response = await fetch(`/status/${taskId}`);
                const data = await response.json();

                // Обновляем статус прогресса
                if (data.state === "PENDING") {
                    statusText.innerText = "Ожидание выполнения задачи...";
                    progressBar.style.width = "0%";
                } else if (data.state === "PROGRESS") {
                    statusText.innerText = `Создание архива... ${data.progress}%`;
                    progressBar.style.width = `${data.progress}%`;
                } else if (data.state === "SUCCESS") {
                    statusText.innerText = "Готово!";
                    progressBar.style.width = "100%";

                    // Перенаправляем на success.html
                    window.location.href = downloadLink;
                } else if (data.state === "FAILURE") {
                    statusText.innerText = "Ошибка при обработке.";
                    alert("Ошибка во время обработки задачи.");
                }

                // Повторяем проверку статуса, если задача не завершена
                if (data.state !== "SUCCESS" && data.state !== "FAILURE") {
                    setTimeout(() => checkStatus(taskId, downloadLink), 1000);
                }
            } catch (error) {
                console.error(error);
                alert("Ошибка получения статуса задачи.");
            }
        }

        // Очистка формы
        function resetForm() {
            form.reset();
            progressContainer.style.display = "none";
            progressBar.style.width = "0%";
            statusText.innerText = "Ожидание начала загрузки...";
        }
    </script>
</body>
</html>
