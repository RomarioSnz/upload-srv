<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Files</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="bg-light">
    <div class="container mt-5 p-4 border rounded shadow bg-white">
        <h1 class="text-center mb-4">Загрузка файлов</h1>

        <!-- Форма загрузки -->
        <form id="uploadForm" enctype="multipart/form-data" class="mb-4">
            <input type="file" id="fileInput" name="files[]" class="form-control mb-3" multiple required>
            <button type="submit" class="btn btn-primary w-100">Загрузить</button>
        </form>

        <!-- Прогресс загрузки -->
        <div id="progressContainer" style="display: none;">
            <p id="statusText">Загрузка файлов...</p>
            <div class="progress mb-3">
                <div id="uploadProgressBar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
            </div>
            <p id="zipStatusText" style="display: none;">Упаковка в ZIP...</p>
            <div id="zipProgressContainer" style="display: none;">
                <div id="zipProgressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%;">0%</div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById("uploadForm");
        const progressContainer = document.getElementById("progressContainer");
        const uploadProgressBar = document.getElementById("uploadProgressBar");
        const zipProgressBar = document.getElementById("zipProgressBar");
        const zipStatusText = document.getElementById("zipStatusText");

        // Загрузка файлов с отображением прогресса
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);

            progressContainer.style.display = "block"; // Показать прогресс-бар
            uploadProgressBar.style.width = "0%";
            uploadProgressBar.innerText = "0%";

            // AJAX-загрузка файлов
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/");
            xhr.upload.onprogress = function (e) {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    uploadProgressBar.style.width = `${percent}%`;
                    uploadProgressBar.innerText = `${percent}%`;
                }
            };

            xhr.onload = async function () {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);

                    if (data.task_id) {
                        zipStatusText.style.display = "block";
                        document.getElementById("zipProgressContainer").style.display = "block";
                        trackZipProgress(data.task_id, data.link);
                    } else {
                        alert("Ошибка при загрузке.");
                    }
                } else {
                    alert("Ошибка сети!");
                }
            };

            xhr.send(formData);
        });

        // Прогресс упаковки ZIP
        async function trackZipProgress(taskId, downloadLink) {
            try {
                const response = await fetch(`/status/${taskId}`);
                const data = await response.json();

                if (data.state === "PENDING") {
                    zipProgressBar.style.width = "0%";
                    zipProgressBar.innerText = "0%";
                } else if (data.state === "PROGRESS") {
                    zipProgressBar.style.width = `${data.progress}%`;
                    zipProgressBar.innerText = `${data.progress}%`;
                } else if (data.state === "SUCCESS") {
                    zipProgressBar.style.width = "100%";
                    zipProgressBar.innerText = "100%";
                    window.location.href = `/success?link=${downloadLink}`;
                    return;
                } else {
                    alert("Ошибка при упаковке в ZIP.");
                    return;
                }

                setTimeout(() => trackZipProgress(taskId, downloadLink), 1000);
            } catch (error) {
                console.error(error);
                alert("Ошибка получения статуса упаковки.");
            }
        }
    </script>
</body>
</html>
